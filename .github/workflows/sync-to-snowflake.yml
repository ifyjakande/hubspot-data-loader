name: Sync HubSpot Data to Snowflake

on:
  # Run manually via workflow dispatch
  workflow_dispatch:

  # Run automatically after load-data workflow completes
  workflow_run:
    workflows: ["Load HubSpot Sample Data"]
    types:
      - completed

concurrency:
  group: hubspot-prod-pipeline-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: false

jobs:
  # Pre-check job: Lightweight check for changes (no Snowflake connection)
  # Only runs for manual triggers (not after workflow_run)
  check-for-changes:
    runs-on: ubuntu-latest
    # Skip pre-check if triggered by workflow_run (data was just loaded, so changes exist)
    if: github.event_name != 'workflow_run'
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      contacts_changed: ${{ steps.check.outputs.contacts_changed }}
      companies_changed: ${{ steps.check.outputs.companies_changed }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Check for changes in HubSpot
      id: check
      env:
        HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA || 'PUBLIC' }}
      run: |
        python check_changes.py

    - name: Changes Summary
      run: |
        if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
          echo "‚úÖ Changes detected:"
          echo "   - Contacts: ${{ steps.check.outputs.contacts_changed }}"
          echo "   - Companies: ${{ steps.check.outputs.companies_changed }}"
          echo "   ‚Üí Proceeding with sync"
        else
          echo "‚è≠Ô∏è  No changes detected - Sync will be skipped"
          echo "   üí∞ Snowflake compute cost saved!"
        fi

  # Sync job: Only runs if changes detected OR triggered by workflow_run
  sync-to-snowflake:
    runs-on: ubuntu-latest
    needs: [check-for-changes]
    # Run if: (1) workflow_run trigger, OR (2) changes detected from pre-check
    if: |
      always() && 
      (
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
        (github.event_name != 'workflow_run' && needs.check-for-changes.result == 'success' && needs.check-for-changes.outputs.has_changes == 'true')
      )

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Sync HubSpot data to Snowflake
      env:
        HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA || 'PUBLIC' }}
      run: |
        python sync_to_snowflake.py

    - name: Sync Summary
      if: success()
      run: |
        echo "‚úÖ Sync completed successfully!"
        echo "Data has been synchronized from HubSpot to Snowflake."
        echo "Check the logs above for reconciliation report."

    - name: Sync Failed
      if: failure()
      run: |
        echo "‚ùå Sync failed! Check the logs above for details."
        exit 1
